---
# yamllint disable rule:line-length
name: Test Nodejs
description: |
  Github Action to Build & Test Nodejs

  RequiredEnv:
    AZ_DEVOP_PAT
    GITHUB_TOKEN
    SONAR_TOKEN
inputs:
  nodejs-version:
    description: >
      The nodejs-version input is optional.
      The default version of Nodejs in PATH varies
      between runners and can be changed unexpectedly
      so we recommend always setting Nodejs version explicitly
      using the nodejs-version input.
    required: false
  npm_package_publish:
    description: Enabled npm Package Publish to AzureDevops.
    required: false
    default: 'false'
  npm_test_script_name:
    description: npm test script name
    required: false
    default: test
  sonar_wait_flag:
    description: Says if Sonar has to wait for analysis
    required: false
runs:
  using: composite
  steps:
    - name: Find Nodejs Packager
      id: packager
      shell: bash
      run: |
        echo "packager=yarn" >> $GITHUB_OUTPUT
        if [ -f "package-lock.json" ]; then
            echo "packager=npm" >> $GITHUB_OUTPUT
        fi

    - name: Set up Nodejs
      uses: actions/setup-node@v6
      with:
        node-version: ${{ inputs.nodejs-version }}
        cache: ${{ steps.packager.outputs.packager }}

    - name: Run pre_test.sh
      shell: bash
      run: |
        pretest_cmd="echo 'NO_PRETEST'"
        if [ -f ".github/actions/pre_test.sh" ]; then
            pretest_cmd="$(cat .github/actions/pre_test.sh)"
        fi
        echo "pretest_cmd: $pretest_cmd"
        sh -c "${pretest_cmd}"

    - name: Install Application node_modules
      shell: bash
      run: |
        echo "::group::Upgrade Packages"
        if [ -f "yarn.lock" ]; then
            yarn install --frozen-lockfile
        fi
        if [ -f "package-lock.json" ]; then
            npm install
            npm ci
        fi
        echo "::endgroup::"

    - name: Run Test
      shell: bash
      run: |
        echo "::group::Run Test"
        args=""
        if [ -f "yarn.lock" ]; then
            args='yarn run ${{ inputs.npm_test_script_name }}'
        fi
        if [ -f "package-lock.json" ]; then
           args='npm run ${{ inputs.npm_test_script_name }}'
        fi
        echo "::endgroup::"
        eval "npx c8 --reporter=html --reporter=text --reporter=json-summary --all $args"

    - name: SonarCloud Scan
      uses: sonarsource/sonarcloud-github-action@master
      if: env.ENABLE_SONAR == 'true'
      with:
        args: >
          -Dsonar.qualitygate.wait=${{ inputs.sonar_wait_flag }}
          -Dsonar.projectKey=${{ env.SONAR_PROJECT_KEY }}
          -Dsonar.organization=${{ env.SONAR_ORG }}
          -Dsonar.javascript.lcov.reportPaths=coverage/lcov.info

    - name: Generate coverage summary
      shell: bash
      if: env.ENABLE_SONAR != 'true'
      run: |
        echo "## ðŸ“Š Test Results Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> coverage-summary.md
        echo '```' >> coverage-summary.md
        npx c8 report --reporter=text >> coverage-summary.md
        echo '```' >> coverage-summary.md

        cat coverage-summary.md >> $GITHUB_STEP_SUMMARY

    - name: Upload coverage artifacts
      uses: actions/upload-artifact@v4
      if: env.ENABLE_SONAR != 'true'
      with:
        name: coverage-reports
        path: |
          coverage/
          coverage-summary.md
